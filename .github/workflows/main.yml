name: StreamWatch Weekly Refresh

on:
  workflow_dispatch:
    inputs:
      run_date:
        description: "Run date (YYYY-MM-DD). Default = today (UTC)"
        required: false
      week_start:
        description: "Week start (YYYY-MM-DD). Optional override. Default = computed"
        required: false
  schedule:
    - cron: "0 13 * * 1"

permissions:
  contents: read

concurrency:
  group: streamwatch-weekly
  cancel-in-progress: false

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      STREAMWATCH_GCS_BUCKET: ${{ secrets.STREAMWATCH_GCS_BUCKET }}
      STREAMWATCH_GCS_PREFIX: ${{ secrets.STREAMWATCH_GCS_PREFIX }}
      STREAMWATCH_GCP_PROJECT: ${{ secrets.STREAMWATCH_GCP_PROJECT }}
      STREAMWATCH_GCP_SA_JSON: ${{ secrets.STREAMWATCH_GCP_SA_JSON }}
      TMDB_V4_TOKEN: ${{ secrets.TMDB_V4_TOKEN }}

      # trends knobs (optional)
      STREAMWATCH_TRENDS_MAX_SHOWS: ${{ secrets.STREAMWATCH_TRENDS_MAX_SHOWS }}
      STREAMWATCH_TRENDS_MAX_SECONDS: ${{ secrets.STREAMWATCH_TRENDS_MAX_SECONDS }}
      STREAMWATCH_TRENDS_BASE_SLEEP: ${{ secrets.STREAMWATCH_TRENDS_BASE_SLEEP }}

      STREAMWATCH_WORK_DIR: ${{ github.workspace }}/.work

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Compute run parameters
        id: params
        shell: bash
        run: |
          # run_date default = today UTC
          if [ -z "${{ github.event.inputs.run_date }}" ]; then
            RUN_DATE=$(date -u +%F)
          else
            RUN_DATE="${{ github.event.inputs.run_date }}"
          fi

          # week_start: allow override from workflow input
          if [ -n "${{ github.event.inputs.week_start }}" ]; then
            WEEK_START="${{ github.event.inputs.week_start }}"
          else
            # Default: prior Sunday (UTC week boundary)
            WEEK_START=$(date -u -d "$RUN_DATE -$(date -u -d "$RUN_DATE" +%u) days" +%F)
          fi

          RUN_ID="gh_${RUN_DATE//-/}_001"

          echo "run_date=$RUN_DATE" >> $GITHUB_OUTPUT
          echo "week_start=$WEEK_START" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

          echo "RUN_DATE=$RUN_DATE"
          echo "WEEK_START=$WEEK_START"
          echo "RUN_ID=$RUN_ID"

      - name: Run StreamWatch refresh
        run: |
          python scripts/refresh_data.py \
            --run-date "${{ steps.params.outputs.run_date }}" \
            --week-start "${{ steps.params.outputs.week_start }}" \
            --run-id "${{ steps.params.outputs.run_id }}"

      - name: Upload run logs/artifacts (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: streamwatch-workdir
          path: .work/
          retention-days: 7
